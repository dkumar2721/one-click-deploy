#!/bin/bash
yum update -y
yum install -y python3 pip git

# Install CloudWatch agent (optional but good practice)
yum install -y amazon-cloudwatch-agent

# Clone or create app
mkdir -p /home/ec2-user/app
cat > /home/ec2-user/app/app.py << 'EOF'
from flask import Flask
import os

app = Flask(__name__)

@app.route('/')
def home():
    return "Hello from private EC2! ðŸŒ\n"

@app.route('/health')
def health():
    return "ok\n"

if __name__ == '__main__':
    port = int(os.environ.get('PORT', ${port}))
    app.run(host='0.0.0.0', port=port)
EOF

cat > /home/ec2-user/app/requirements.txt << 'EOF'
flask==3.0.3
EOF

cd /home/ec2-user/app
pip3 install -r requirements.txt

# Run app in background
nohup python3 app.py > /var/log/api.log 2>&1 &
