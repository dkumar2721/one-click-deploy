#!/bin/bash
dnf update -y
dnf install -y python3-pip git

# Create app
mkdir -p /home/ec2-user/app
cat > /home/ec2-user/app/app.py << 'EOF'
from flask import Flask
import os

app = Flask(__name__)

@app.route('/')
def home():
    return "Hello from private EC2! ðŸŒ\n"

@app.route('/health')
def health():
    return "ok\n"

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8080))  # â† hardcoded fallback
    app.run(host='0.0.0.0', port=port)
EOF

cat > /home/ec2-user/app/requirements.txt << 'EOF'
flask==3.0.3
EOF

cd /home/ec2-user/app
pip3 install -r requirements.txt

# Run app in background
nohup python3 app.py > /var/log/api.log 2>&1 &
echo "App started on port 8080"
